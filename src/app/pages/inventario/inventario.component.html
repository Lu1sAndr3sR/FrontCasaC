<div class="inventory-page">

  <div class="top-bar">
    <div class="top-left">
      <img src="assets/logoC.png" class="logo" alt="logo" routerLink="/dashboard" style="cursor: pointer;">
    </div>

    <div class="top-center">
      <div class="menu-inline">
        <span class="menu-item" (click)="goTo('/caja')">Nueva Venta</span>
        <span class="menu-item active">Inventario</span>
        <span class="menu-item" (click)="goTo('/reportes')">Reportes</span>
      </div>

      <div class="search-row">
        <div class="search-box">
          <i class="bi bi-search"></i>
          <input type="text" 
                 placeholder="Buscar por nombre, c√≥digo o categor√≠a..." 
                 [(ngModel)]="textoBuscador"
                 (input)="buscar($event)">
          <div class="search-tools">Total: {{ filtered.length }}</div>
        </div>
      </div>
    </div>

    <div class="top-right">
      <div class="cajero-label">
        CAJERO: <span style="color: #fff; font-weight: 400; text-transform: uppercase;">{{ nombreCajero }}</span>
      </div>
      <div class="datetime">{{ fechaActual }} &nbsp; - &nbsp; {{ horaActual }}</div>
    </div>
  </div>

  <div class="main-area">

    <div class="inventory-header">
      <div class="inventory-title">
        <div class="ico-red"><span>‚åÅ</span></div>
        <h1>Inventario Ferreter√≠a</h1>
      </div>

      <div class="filters">
        <button class="btn-filter" [class.active]="selectedFilter==='todos'" (click)="selectFilter('todos')">Todos</button>
        <button class="btn-filter" [class.active]="selectedFilter==='bajo'" (click)="selectFilter('bajo')">Bajo Stock </button>
        <button class="btn-filter" [class.active]="selectedFilter==='categoria'" (click)="openCategorias()">Categor√≠as</button>
      </div>
    </div>

    <div class="table-card">
      <div class="table-head">
        <div>Nombre de Producto</div>
        <div>C√≥digo</div>
        <div>P. P√∫blico</div>
        <div>P. Mayoreo</div>
        <div>Stock</div>
        <div>Acciones</div>
      </div>

      <div class="table-body">
        @for (p of filtered; track p.producto_id) {
          <div class="row">
            <div class="cell name">
              <div class="big">{{ p.nombre }}</div>
              <div class="small" style="color:#888;">{{ p.descripcion }}</div>
            </div>
            <div class="cell sku">{{ p.codigo_barras }}</div>
            <div class="cell price">${{ p.precio_menudeo | number:'1.2-2' }}</div>

            <div class="cell price" style="color: #2d6cdf; font-weight: 600;">
                ${{ p.precio_mayoreo | number:'1.2-2' }}
            </div>
            
            <div class="cell stock" [class.low]="p.stock_actual <= 5">
              {{ p.stock_actual }}
            </div>
            
            <div class="cell actions">
              <button class="icon-stock" title="Surtir (Entrada)" (click)="abrirModalStock(p, 'ENTRADA')">üì•</button>
              <button class="icon-stock warn" title="Merma (Salida)" (click)="abrirModalStock(p, 'AJUSTE')">üìâ</button>
              
              <button class="link" (click)="editar(p)">Editar</button>
              <button class="icon-del" (click)="eliminar(p)">üóëÔ∏è</button>
            </div>
          </div>
        } @empty {
          <div class="row" style="justify-content: center; padding: 20px; color: #666;">
            Sin resultados.
          </div>
        }
      </div>
    </div>

    <button class="fab" title="Agregar Producto" (click)="abrirModalAgregar()">+</button>

  </div>

  <div class="modal-backdrop" *ngIf="modalCategorias">
    <div class="modal">
      <h3>Filtrar por Categor√≠a</h3>
      <ul>
        <li *ngFor="let c of categorias" (click)="filterByCategory(c)">{{ c }}</li>
      </ul>
      <div class="modal-actions">
        <button class="btn close" (click)="closeCategorias()">Cerrar</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="modalAgregar">
    <div class="modal modal-agregar">
      <h3>Nuevo Producto</h3>
      <div class="form-row">
        <div class="form-group">
            <label>Nombre del producto *</label>
            <input type="text" [(ngModel)]="nuevo.nombre" placeholder="Ej. Cemento Gris">
        </div>
        <div class="form-group">
            <label>C√≥digo de Barras *</label>
            <input type="text" [(ngModel)]="nuevo.barras" placeholder="Escanea aqu√≠">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
            <label>Categor√≠a</label>
            <input list="lista-categorias" [(ngModel)]="nuevo.categoria" placeholder="Escribe o selecciona">
            <datalist id="lista-categorias">
                <option *ngFor="let c of categorias" [value]="c"></option>
                <option value="Herramientas"></option>
                <option value="Plomer√≠a"></option>
                <option value="Electricidad"></option>
            </datalist>
        </div>
        <div class="form-group short">
            <label>Stock M√≠nimo</label>
            <input type="number" [(ngModel)]="nuevo.stockMinimo">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
            <label>Precio P√∫blico</label>
            <input type="number" [(ngModel)]="nuevo.precioMenudeo">
        </div>
        <div class="form-group">
            <label>Precio Mayoreo</label>
            <input type="number" [(ngModel)]="nuevo.precioMayoreo">
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn cancel" (click)="cerrarModalAgregar()">Cancelar</button>
        <button class="btn save" (click)="guardarProducto()">Guardar</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="modalEditar">
    <div class="modal modal-agregar">
      <h3>Editar Producto</h3>
      <div class="form-row">
        <div class="form-group">
            <label>Producto</label>
            <input type="text" [value]="productoEditando.nombre" disabled style="opacity:0.6; cursor:not-allowed;">
        </div>
        <div class="form-group">
            <label>C√≥digo</label>
            <input type="text" [value]="productoEditando.codigo_barras" disabled style="opacity:0.6; cursor:not-allowed;">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
            <label style="color:#81c784;">Precio P√∫blico ($)</label>
            <input type="number" [(ngModel)]="productoEditando.precio_menudeo">
        </div>
        <div class="form-group">
            <label style="color:#81c784;">Stock Actual (Solo lectura)</label>
            <input type="number" [value]="productoEditando.stock_actual" disabled style="opacity:0.6; cursor:not-allowed;">
        </div>
      </div>
      <div class="form-row">
         <div class="form-group">
            <label>Precio Mayoreo ($)</label>
            <input type="number" [(ngModel)]="productoEditando.precio_mayoreo">
         </div>
         <div class="form-group"></div>
      </div>
      <div class="modal-actions">
        <button class="btn cancel" (click)="cerrarModalEditar()">Cancelar</button>
        <button class="btn save" (click)="guardarEdicion()">Guardar Cambios</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="modalStock">
    <div class="modal modal-agregar">
      <h3 [style.color]="tipoMovimiento === 'ENTRADA' ? '#4cd96f' : '#ff5f5f'">
        {{ tipoMovimiento === 'ENTRADA' ? 'üì• Recibir Mercanc√≠a' : 'üìâ Reportar P√©rdida' }}
      </h3>
      
      <p style="margin-bottom: 15px; color: #aaa; font-size: 14px;">
        Producto: <strong style="color: #fff;">{{ productoStock?.nombre }}</strong>
        <br>
        Stock Actual: <strong style="color: #fff;">{{ productoStock?.stock_actual }}</strong>
      </p>

      <div class="form-row">
        <div class="form-group">
          <label>Cantidad a {{ tipoMovimiento === 'ENTRADA' ? 'Agregar' : 'Restar' }}</label>
          <input type="number" [(ngModel)]="cantidadMov" placeholder="0" autofocus>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Motivo / Observaci√≥n</label>
          <input type="text" [(ngModel)]="razonMov" 
                 [placeholder]="tipoMovimiento === 'ENTRADA' ? 'Ej: Factura 504' : 'Ej: Se rompi√≥ / Caduc√≥'">
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn cancel" (click)="cerrarModalStock()">Cancelar</button>
        <button class="btn save" (click)="guardarMovimiento()">Confirmar Movimiento</button>
      </div>
    </div>
  </div>

</div>